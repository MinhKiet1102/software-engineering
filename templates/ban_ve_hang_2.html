{% extends "layout/base.html" %}
{% block main_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/class_2.css') }}">
<div class="container mt-5">

    <div class="content">
        <form method="post"
            action="{{ url_for('ban_ve_routes.xac_nhan_ban_ve', id=ticket_flight.id, schedule_flight_id=schedule_flight.id) }}">
            <div class="seat-selection">
                <input type="hidden" name="ticket_id" value="{{ ticket_flight.id }}">
                <input type="hidden" name="schedule_flight_id" value="{{ schedule_flight.id }}">
                <div class="header">
                    <div class="flight-info">
                        <div>‚úàÔ∏è<span style="color: #304558;">Chuy·∫øn Bay:</span> {{ schedule_flight.flight_id }}</div>
                        <div>üìÖ<span style="color: #304558;">Ng√†y: </span>{{
                            schedule_flight.start_date.strftime('%d/%m/%Y') }}</div>
                        <div>‚è∞<span style="color: #304558;">Gi·ªù:</span> {{ schedule_flight.start_date.strftime('%H:%M')
                            }}</div>
                    </div>
                </div>
                <h2>Ch·ªçn Ch·ªó Ng·ªìi</h2>
                <div class="note">
                    <div>
                        <div class="blue-box"></div><span>ƒê√£ ch·ªçn</span>
                    </div>
                    <div>
                        <div class="red-box"></div><span>ƒê√£ ƒë·∫∑t</span>
                    </div>
                    <div class="toilet">
                        <i class="fa-solid fa-restroom"></i>
                        <span style="margin-left: 5px;">Ph√≤ng v·ªá sinh</span>
                    </div>
                    <div class="kitchen">
                        <i class="fa-solid fa-utensils"></i>
                        <span style="margin-left: 5px;">Ph√≤ng b·∫øp</span>
                    </div>
                    <div class="exit-door">
                        <i class="fa-solid fa-door-open" style="color: red;"></i>
                        <span style="margin-left: 5px;">C·ª≠a ra v√†o</span>
                    </div>
                </div>
                <div class="seat-map">
                    <div>
                        <div>

                            <div class="section-header">
                                <div style="text-align: center;font-size:25px">Gh·∫ø h·∫°ng 1</div>
                                <hr />
                            </div>
                            <div class="exit-doors">
                                <i class="fa-solid fa-door-open"></i>
                                <i class="fa-solid fa-door-open"></i>
                            </div>
                            <div class="kitchen-row top-kitchen">
                                <i class="fa-solid fa-utensils"></i>
                                <i class="fa-solid fa-utensils"></i>
                                <i class="fa-solid fa-utensils"></i>
                            </div>
                            <div class="seat-layout">
                                {% for row in range(0, (total_seats_class_1 + 3) // 4) %}
                                <div class="row">
                                    <div class="row-label">{{ 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[row] }}</div>
                                    <div class="seats">
                                        {% for col in range(1, 5) %}
                                        {% if row * 4 + col <= total_seats_class_1 %} <button type="button"
                                            class="seat-1 seat {% if (row * 4 + col)|string in booked_seats_list_class_1 %}booked{% endif %}"
                                            data-seat="{{ row * 4 + col }}" disabled>
                                            {{ row * 4 + col }}
                                            </button>
                                            {% endif %}
                                            {% if col == 2 %}
                                            <div class="aisle"></div>
                                            {% endif %}
                                            {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="toilet-row bottom-toilets">
                                <i class="fa-solid fa-restroom"></i>
                                <i class="fa-solid fa-restroom"></i>
                                <i class="fa-solid fa-restroom"></i>
                                <i class="fa-solid fa-restroom"></i>
                            </div>
                            <div class="section-header">
                                <div style="text-align: center;font-size:25px">Gh·∫ø h·∫°ng 2</div>
                                <hr />
                            </div>
                            <!-- Icon c·ª≠a ra v√†o hai b√™n -->
                            <div class="exit-doors">
                                <i class="fa-solid fa-door-open"></i>
                                <i class="fa-solid fa-door-open"></i>
                            </div>
                            <div class="kitchen-row top-kitchen">
                                <i class="fa-solid fa-utensils"></i>
                                <i class="fa-solid fa-utensils"></i>
                                <i class="fa-solid fa-utensils"></i>
                            </div>

                            <div class="seat-layout">
                                {% for row in range(0, (total_seats_class_2 + 3) // 4) %}
                                <div class="row">
                                    <div class="row-label">{{ 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[row] }}</div>
                                    <div class="seats">
                                        {% for col in range(1, 5) %}
                                        {% if row * 4 + col <= total_seats_class_2 %} <button type="button"
                                            class="seat-2 seat {% if (row * 4 + col)|string in booked_seats_list_class_2 %}booked{% endif %}"
                                            data-seat="{{ row * 4 + col }}">
                                            {{ row * 4 + col }}
                                            </button>
                                            {% endif %}
                                            {% if col == 2 %}
                                            <div class="aisle"></div>
                                            {% endif %}
                                            {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="toilet-row bottom-toilets">
                                <i class="fa-solid fa-restroom"></i>
                                <i class="fa-solid fa-restroom"></i>
                                <i class="fa-solid fa-restroom"></i>
                                <i class="fa-solid fa-restroom"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="seat_numbers" id="seat_numbers">
            </div>
            <div class="booking-details">
                <h2>Chi Ti·∫øt B√°n V√©</h2>
                <p>H√†nh Tr√¨nh: {{ schedule_flight.flight.start_location }} - {{ schedule_flight.flight.destination }}
                </p>
                <p>H·∫°ng Gh·∫ø: {{ ticket_flight.ticket_class }}</p>
                <p>S·ªë Gh·∫ø: <span id="selected-seat">Ch∆∞a ch·ªçn</span></p>
                <p>Gi√° V√© C∆° B·∫£n: <span id="base-price">{{ "{:,.0f}".format(ticket_flight.price).replace(",", ".")
                        }}</span> VND</p>
                <p>Ph√≠ D·ªãch V·ª•: <span id="service-fee">0</span> VND</p>
                <p>
                    <strong>
                        T·ªïng C·ªông: <span id="total-price">0</span> VND
                    </strong>
                </p>
                <button type="submit" class="btn-confirm">Ti·∫øp T·ª•c B√°n V√©</button>
            </div>
        </form>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const basePrice = parseInt(document.getElementById('base-price').innerText.replace(/\./g, ''), 10);
        const serviceFeePerSeat = 100000;
        const selectedSeatElement = document.getElementById('selected-seat');
        const serviceFeeElement = document.getElementById('service-fee');
        const totalPriceElement = document.getElementById('total-price');
        let selectedSeats = []; // L∆∞u danh s√°ch c√°c gh·∫ø ƒë∆∞·ª£c ch·ªçn

        // H√†m c·∫≠p nh·∫≠t chi ti·∫øt ƒë·∫∑t ch·ªó
        function updateBookingDetails() {
            const seatCount = selectedSeats.length;
            const totalServiceFee = seatCount * serviceFeePerSeat;
            const totalPrice = (seatCount * basePrice) + totalServiceFee;

            // C·∫≠p nh·∫≠t th√¥ng tin tr√™n giao di·ªán
            selectedSeatElement.innerText = selectedSeats.join(', ') || 'Ch∆∞a ch·ªçn';
            serviceFeeElement.innerText = totalServiceFee.toLocaleString('vi-VN');
            totalPriceElement.innerText = totalPrice.toLocaleString('vi-VN');

            // C·∫≠p nh·∫≠t gi√° tr·ªã cho hidden input (n·∫øu c·∫ßn g·ª≠i l√™n server)
            document.getElementById('seat_numbers').value = selectedSeats.join(',');
        }

        // G·∫Øn s·ª± ki·ªán click cho c√°c gh·∫ø
        document.querySelectorAll('.seat').forEach(seat => {
            // Ch·ªâ th√™m s·ª± ki·ªán click v√†o c√°c gh·∫ø ch∆∞a b·ªã booked
            if (!seat.classList.contains('booked')) {
                seat.addEventListener('click', function () {
                    const seatNumber = this.dataset.seat;

                    // Ki·ªÉm tra gh·∫ø ƒë√£ ƒë∆∞·ª£c ch·ªçn hay ch∆∞a
                    if (selectedSeats.includes(seatNumber)) {
                        // B·ªè ch·ªçn gh·∫ø
                        selectedSeats = selectedSeats.filter(seat => seat !== seatNumber);
                        this.classList.remove('selected');
                    } else {
                        // Th√™m gh·∫ø v√†o danh s√°ch ƒë∆∞·ª£c ch·ªçn
                        selectedSeats.push(seatNumber);
                        this.classList.add('selected');
                    }

                    // C·∫≠p nh·∫≠t chi ti·∫øt ƒë·∫∑t ch·ªó
                    updateBookingDetails();
                });
            }
        });
    });
</script>
{% endblock %}